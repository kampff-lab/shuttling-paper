\section{Methods}

All experiments were approved by the Champalimaud Foundation Bioethics Committee and the Portuguese National Authority for Animal Health, Direcção\hyp{}Geral de Alimentação e Veterinária (DGAV).

\subsection{Permanent lesions}

Ibotenic acid was injected bilaterally in 11 Long-Evans rats (ages from 83 to 141 days; 9 females, 2 males), at 3 injection sites with 2 depths per site (\SI{-1.5}{\milli\meter} and \SI{-0.75}{\milli\meter} from the surface of the brain). At each depth we injected a total amount of \SI{82.8}{\nano\liter} using a microinjector (Drummond Nanoject II, \SI{9.2}{\nano\liter} per injection, 9 injections per depth). The coordinates for each site, in \si{\milli\meter} with respect to Bregma, were: +1.0 AP / 2.0 ML; +1.0 AP / 4.0 ML; +3.0 AP / 2.0 ML, following the protocol reported by Kawai et al. for targeting forelimb motor cortex \citep{Kawai2015}. Five other animals were used as sham controls (age-matched controls; 3 females, 2 males), subject to the same intervention, but where ibotenic acid was replaced with physiological saline. Six additional animals were used as wildtype, no-surgery, controls (age-matched controls; 6 females).

For the frontal cortex aspiration lesions, the margins of the craniotomy were extended to cover from -2.0 to +5.0 \si{\milli\meter} AP relative to Bregma and laterally from 0.5 \si{\milli\meter} up to the temporal ridge of the skull. After removal of the skull, the exposed dura was cut and removed, and the underlying tissue aspirated to a depth of 2 to 3 \si{\milli\meter} with a fine pipette \citep{Whishaw2000}. For the frontoparietal cortical lesions, the craniotomy extended from -6.0 to +4.0 \si{\milli\meter} AP relative to Bregma and laterally from 0.5 \si{\milli\meter} up to the temporal ridge. Two of these animals underwent aspiration lesions as described above. In the remaining animal, the lesion was induced by pial stripping in order to further restrict the damage to cortical areas. After removal of the dura, the underlying pia, arachnoid and vasculature were wiped with a sterile cotton swab until no vasculature was visible \citep{Farr2002}.

\subsection{Recovery period}

After the surgeries, animals were given a minimum of one week (up to two weeks) recovery period in isolation. After this period, animals were handled every day for a week, after which they were paired again with their age-matched control to allow for social interaction during the remainder of the recovery period. In total, all animals were allowed at least one full month of recovery before they were first exposed to the behaviour assay.

The three largest frontoparietal lesioned animals were originally prepared for a study of behaviour in a dynamic visual foraging task, which they were exposed to for one month in addition to the recovery period described above. This task did not, however, require any challenging motor behaviours besides locomotion over a completely flat surface. This period was also used to monitor the overall health condition of the animals and to facilitate sensorimotor recovery as much as possible. The animal with the largest lesion (Extended Lesion F) was prevented from completing the behaviour protocol due to deteriorating health conditions following the first two days of testing.

\subsection{Histology}

All animals were perfused intracardially with 4\% paraformal\-dehyde in phosphate buffer saline (PBS) and brains were post-fixed for at least \SI{24}{\hour} in the same fixative. Serial coronal sections (\SI{100}{\micro\meter}) were Nissl-stained and imaged for identification of lesion boundaries. In two of the largest frontoparietal lesions (Extended Lesions D and E), serial sections were taken sagittally.

In order to reconstruct lesion volumes, the images of coronal sections were aligned and the outlines of both brain and lesions were manually traced in Fiji \citep{Schindelin2012} and stored as two-dimensional regions of interest. Lesion volumes were calculated by summing the area of each region of interest multiplied by the thickness of each slice. The stored regions were also used to reconstruct a 3D polygon mesh for visualization of lesion boundaries.

\subsection{Electrocorticography}

Recording of electrophysiological signals from the intact rodent cortex was performed using two high-density 64-channel micro-electrocorticography (micro-ECoG) grids using the method reported by Dimitriadis et al. for freely moving animals \citep{Dimitriadis2014}. The particular grids used in these experiments were fabricated at the International Iberian Nanotechnology Laboratory by depositing microelectrode gold contacts through a custom designed layout mask on a flexible thin-film polyimide substrate (Figure \ref{fig:ecog}A). The soft connectors at the end of each grid are inserted during the implantation surgery into a custom made breakout board in the recording chamber, which exposes groups of 32-channels via Omnetics connectors to the recording amplifier (see data acquisition section).

The microelectrode grids were implanted epidurally into the right hemisphere of three male Long-Evans rats at almost two years of age. The margins of the craniotomy for implantation extended from -3.3 to +5.0 \si{\milli\meter} AP relative to Bregma and laterally from 1.5 to 4.0 \si{\milli\meter}. The anterior grid was first placed carefully on top of the brain, and then slowly inserted below the anterior and medial margins of the craniotomy until the first rows of electrodes were fully covered. The second grid was placed posterior to the first one and inserted below the medial margin of the craniotomy, taking care that the first rows of electrodes were kept equidistant from the last row of electrodes in the anterior grid. Two zirconium hooks were inserted in the anterior and posterior margins of the craniotomy and fixed to the recording chamber in order to hold it firmly in place relative to the skull. With the aid of a micromanipulator and video feedback system, the coordinates of different electrodes in each quadrant of both grids were measured relative to Bregma, and later used to reconstruct the precise placement of all grid electrodes in the brain. At the end of the surgery, a titanium screw was inserted posteriorly to the craniotomy in contact with the brain in order to be used as reference for the recording system. The stability of the implant depends critically on the absence of movement in the bony plates of the skull during development, which can compromise the mechanical fixation of the recording chamber to the head \citep{Dimitriadis2014}. For this reason, it is recommended that rats undergoing this procedure should be older than 7 months \citep{Dimitriadis2014}.

\subsection{Behaviour assay}

During each session the animal was placed inside a behaviour box for \SI{30}{\minute}, where it could collect water rewards by shuttling back and forth between two nose pokes (Island Motion Corporation, USA). To do this, animals had to cross a \SI{48}{\centi\meter} obstacle course composed of eight \SI{2}{\centi\meter} aluminium steps spaced by \SI{4}{\centi\meter} (Figure \ref{fig:assay}A). The structure of the assay and each step in the obstacle course was built out of aluminium structural framing (Bosch Rexroth, DE, \SI{20}{\milli\meter} series). The walls of the arena were fabricated with a laser-cutter from \SI{5}{\milli\meter} thick opaque black acrylic and fixed to the structural framing. A transparent acrylic window partition was positioned in front of the obstacle course in order to provide a clear view of the animal. All experiments were run in the dark by having the behavioural apparatus enclosed in a light tight box.

A motorized brake allowed us to lock or release each step in the obstacle course (Figure \ref{fig:assay}B). The shaft of each of the obstacles was coupled to an acrylic piece used to control the rotational stability of each step. In order to lock a step in a fixed position, two servo motors are actuated to press against the acrylic piece and hold it in place. Two other acrylic pieces were used as stops to ensure a maximum rotation angle of approximately +/- \ang{100}. Two small nuts were attached to the bottom of each step to work as a counterweight that gives the obstacles a tendency to return to their original flat configuration. In order to ensure that noise from servo motor actuation could not be used as a cue to tell the animal about the state of each step, the motors were always set to press against an acrylic piece, either the piece that keeps the step stabilized, or the acrylic stops. At the beginning of each trial, the motors were run through a randomized sequence of positions in order to mask information about state transitions and also to ensure the steps were reset to their original configuration. Control of the motors was done using a Motoruino board (Artica, PT) along with a custom workflow written in the Bonsai visual programming language \citep{Lopes2015a}.

Prior to the micro-ECoG recordings, each step in the obstacle course was outfitted with a micro load cell (CZL616C, Phidgets, CA) secured between the step front holder and the base (Figure \ref{fig:assay}B). This allowed us to record a varying voltage signal proportional to the load applied by the animal on each step. This load signal was acquired simultaneously on all eight steps and digitized synchronously with the ECoG data acquisition system.

\subsection{Data acquisition}

The behaviour of the animals was recorded with a high-speed and high-resolution videography system (1280x680 @ \SI{120}{\hertz}) using an infrared camera (Flea3, PointGrey, CA), super-bright infrared LED front lights (SMD5050, 850 nm) and a vari-focal lens (Fujinon, JP) positioned in front of the transparent window partition. A top view of the assay was simultaneously recorded with the same system at a lower frame-rate (\SI{30}{\hertz}) for monitoring purposes. All video data was encoded with MPEG-4 compression for subsequent offline analysis. Behaviour data acquisition for the nose poke beam breaks was done using an Arduino board (Uno, Arduino, USA) and streamed to the computer via USB. All video and sensor data acquisition was recorded in parallel using the same Bonsai workflow used to control the behaviour assay.

For the micro-ECoG recordings, all electrophysiological signals were amplified, digitized and multiplexed using two 64-channel amplifier boards (RHD2164, Intan Technologies, US) connected to the electrode interface board (EIB) on the recording chamber. The amplifier boards were then connected through a dual headstage adapter (C3440, Intan Technologies, US) to the main data acquisition USB interface board (RHD2000-Eval, Intan Technologies, US). In order to facilitate the free movement of the animal in the behaviour box, the single cable connecting the head of the animal to the USB interface board was passed through a slip ring (MMC235, Moflon, CN) and hooked into a nylon string crossing the top of the assay. In this way, movement and rotation of the tethered animal were compensated to avoid unwanted strain and twisting on the cables during the entire recording period.

In order to synchronize the videography and ECoG recording systems, we connected the strobe output of the camera to a digital input in the Intan USB interface board using a GPIO cable (ACC-01-3000, PointGrey, CA). The camera strobe output is electronically coupled to individual frame exposures (i.e. shutter opening and closing events), and can be used for sub-millisecond readout of individual frame acquisition times. The strobe signal was acquired and digitized synchronously with ECoG data acquisition, and used for \emph{post-hoc} reconstruction of precise frame timing. Data acquisition from the USB interface board was recorded using a Bonsai workflow and care was taken that it was always started first and terminated last in order to ensure that no external synchronization events were lost.

\subsection{Behaviour protocol}

The animals were kept in a state of water deprivation for \SI{20}{\hour} prior to each daily session. For every trial, rats were delivered a \SI{20}{\micro\liter} drop of water. At the end of each day, they were given free access to water for \SI{10}{\minute} before initiating the next deprivation period. Sessions lasted for six days of the week from Monday to Saturday, with a day of free access to water on Sunday. Before the start of the water deprivation protocol, animals were run on a single habituation session where they were placed in the box for a period of \SI{15}{\minute}.

The following sequence of conditions were presented to the animals over the course of a month (see also Figure \ref{fig:assay}A): day 0, habituation to the box; day 1-4, all the steps were fixed in a stable configuration; day 5, 20 trials of the stable configuration, after which the two centre steps were made unstable (i.e. free to rotate); day 6-10, the centre two steps remained unstable; day 11, 20 trials of the unstable configuration, after which the two centre steps were again fixed in a stable state; day 12, all the steps were fixed in a stable configuration; day 13-16, the state of the centre two steps was randomized on a trial-by-trial basis to be either stable or unstable. Following the end of the random protocol, animals continued to be tested in the assay for a variable number of days (up to one week) in different conditions. At the end of the testing period, all animals were exposed to a final session where all steps were made free to rotate in order to assay locomotion performance under challenging conditions.

For the micro-ECoG recordings, the basic behaviour protocol was adjusted to allow for extra recording time during conditions of interest. First, all session times were doubled for the recordings (e.g. \SI{30}{\minute} for the habituation session, and \SI{60}{\minute} for all other sessions). Second, the number of days on each condition was also extended to allow extracting more trials from each animal for analysis. Finally, the condition where the centre two steps were reliably unstable was replaced with a condition of rare instability. In this condition, after the animal is exposed to an unstable configuration, the steps are reverted back to being stable for another 20 trials, after which they become again unstable for one trial, and so on.

\subsection{Data analysis}

All scripts and custom code used for data analysis are available online\footnote{https://bitbucket.org/kampff-lab/shuttling-analysis}. The raw video data was first pre-processed using a custom Bonsai workflow in order to extract features of interest (Figure \ref{fig:assay}C). Tracking of the nose was achieved by background subtraction and connected component labelling of segmented image elements. First we compute the ellipse best-fit to the largest object in the image. We then mark the tip of the nose as the furthermost point, in the segmented shape of the animal, along the major axis of the ellipse. In order to analyse stepping performance, regions of interest were defined around the surface of each step and in the gaps between the steps. Background subtracted activity over these regions was recorded for every frame for subsequent detection and classification of steps and slips.

Analysis routines were run using the NumPy scientific computing package \citep{Walt2011} and the Pandas data analysis library \citep{McKinney2010} for the Python programming language. Crossings were automatically extracted from the nose trajectory data by first detecting consecutive time points where the nose was positively identified in the video. In order for these periods to be successfully marked as crossings, the starting position of the nose must be located on the opposite side of the ending position. Inside each crossing, the moment of stepping with the forelimb on the centre steps was extracted by looking at the first peak above a threshold in the first derivative of the activation signal in the corresponding region of interest. False positive classifications due to hindlimb or tail activations were eliminated by enforcing the constraint that the position of the head must be located before the next step. Visual confirmation of the classified timepoints showed that spurious activations were all but eliminated by this procedure as stepping with the hindlimb or tail requires the head to be further ahead in space unless the animal turned around (in which case the trajectory would not be marked as a crossing anyway). The position of the nose at the moment of each step was extracted and found to be normally distributed, so statistical analysis of the step posture in the random condition used an unpaired t-test to check for independence of different measurement groups.

In order to evaluate the dynamics of crossing in the random condition, we first measured for every trial the speed at which the animals were moving on each spatial segment of the assay. To minimize overall trial-by-trial variation in individual animal performance, we used the average speed at which the animal approached the manipulated step as a baseline and subtracted it from the speed at each individual segment. To summarize differences in performance between stable and unstable trials, we then computed the average speed profile for each condition, and then subtracted the average speed profile for unstable trials from the average speed profile for stable trials. Finally, we computed the sum of all these speed differences at every segment in order to obtain the speedup index for each animal, i.e. an index of whether the animal tends to accelerate or decelerate across the assay on stable versus unstable trials.

For the micro-ECoG experiments, evoked potentials were analysed by splitting the raw physiological voltage traces into \SI{750}{\milli\second} windows, where time zero was aligned to the moment of stepping with the forelimb on one of the obstacles in the course (see below). Each individual time series was low-pass filtered at \SI{50}{\hertz} (4th order Butterworth filter, two-pass) and baselined by subtracting the average of the first \SI{250}{\milli\second} before event onset in order to compensate for constant voltage shifts between the two grids. Some of the channels in each grid were entirely excluded from the analysis due to potentially damaged surface contacts, as evidenced by wide amplitude, random oscillatory behaviour, which was often matched by the presence of high impedance measurements extracted from the electrode site in vivo. In one of the sessions, the cable connecting the headstage to the interface board was accidentally removed by the animal, and all the trials falling during this period had to be excluded from analysis. Correspondence between individual ECoG samples and video frames was computed by matching the individual hardware frame counter with the sequence of falling edges detected in the shutter strobe signal acquired from the infrared camera.

\subsection{Video classification}

Classification of paw placement faults (i.e. slips) was performed in semi-automated fashion. First, possible slip timepoints were detected automatically using the peak detection method outlined above. All constraints on head position were relaxed for this analysis in order to exclude the possibility of false negatives. A human classifier then proceeded to manually go through each of the slip candidates and inspect the video around that timepoint in order to assess whether the activation peak was a genuine paw placement fault. Examples of false positives include tail and head activations as well as paw activations that occur while the animal is actively engaged in exploration, rearing, or other activities that are unrelated to crossing the obstacles.

A similar technique was used to detect and classify the event onsets for the analysis of evoked potentials in the micro-ECoG experiments. In this case, a preliminary classification of each video frame into left and right forelimb was achieved by first computing the brightness histogram of each frame, which was used to encode the image as a lower-dimensional vector. The vectors for all step frames were subsequently clustered using K-means and then manually inspected for label correction.

Classification of behaviour responses following first exposure to the unstable condition was done on a frame-by-frame analysis of the high-speed video aligned on first contact with the manipulated step. The frame of first contact was defined as the first frame in which there is noticeable movement of the step caused by animal contact. Three main categories of behaviour were observed to follow the first contact: compensation, investigation and halting. Behaviour sequences were first classified as belonging to one of these categories and their onsets and offsets determined by the following criteria. Compensation behaviour is defined by a rapid and adaptive postural correction to the locomotion pattern in response to the perturbation. Onset of this behaviour is defined by the first frame in which there is visible rapid contraction of the body musculature following first contact. Investigation behaviour consists of periods of targeted interaction with the steps, often involving manipulation of the freely moving obstacle with the forepaws. The onset of this behaviour is defined by the animal orienting its head down to one of the manipulated steps, followed by subsequent interaction. Halting behaviour is characterized by a period in which the animal stops its ongoing motor program, and maintains the same body posture for several seconds, without switching to a new behaviour or orienting specifically to the manipulated steps. This behaviour is distinct from a freezing response, as occasional movements of the head are seen. Onset of this behaviour is defined by the moment where locomotion and other motor activities besides movement of the head come to a stop. A human classifier blind to the lesion condition was given descriptions of each of these three main categories of behaviour and asked to note onsets and offsets of each behaviour throughout the videos. These classifications provide a visual summary of the first response videos; the complete dataset used for this classification is included as supplementary movies.
